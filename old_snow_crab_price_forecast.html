<!DOCTYPE html>
<html lang="en">
<head>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6539VRG29E"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6539VRG29E');
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snow Crab Price Model Forecast - Seafood Datasearch</title>
    <link rel="stylesheet" href="assets/style.css">
    <style>
        body {
            font-family: "Arial", sans-serif;
            background-color: #E0F2F1; /* Very light sea green */
            margin: 0;
            padding: 0;
        }
        
        header {
            padding: 20px;
            text-align: center;
            background-color: #B2DFDB; /* Slightly darker sea green for header */
        }
        
        .page-container {
            display: flex;
            min-height: calc(100vh - 200px); /* Adjust based on header and footer height */
        }
        
        .left-pane {
            flex: 1;
            padding: 20px;
            background-color: #E0F2F1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #B2DFDB;
        }
        
        .center-pane {
            flex: 2;
            padding: 20px;
            background-color: #FFFFFF;
            text-align: center;
        }
        
        .right-pane {
            flex: 1;
            padding: 20px;
            background-color: #E0F2F1;
            border-left: 1px solid #B2DFDB;
        }
        
        .logo {
            width: 90%;
            max-width: 300px;
            height: auto;
            margin-bottom: 20px;
        }
        
        .tagline {
            font-style: italic;
            color: #00796B;
            text-align: center;
        }
        
        .chart-content {
            background-color: #F5F5F5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-menu {
            background-color: #F5F5F5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-menu ul {
            list-style-type: none;
            padding: 0;
        }
        
        .nav-menu li {
            margin: 10px 0;
        }
        
        .nav-menu a {
            text-decoration: none;
            color: #00796B;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
            display: block;
        }
        
        .nav-menu a:hover {
            background-color: #B2DFDB;
        }
        
        .species-icons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            padding: 10px;
        }
        
        .species-icons img {
            width: 80px;
            height: auto;
        }
        
        footer {
            padding: 20px;
            background-color: #B2DFDB;
            text-align: center;
        }
        
        /* Chart container styles */
        #chart-container-wrapper {
            width: 100%;
            margin-top: 20px;
        }
        
        #chart-container {
            height: 400px;
            width: 100%;
        }
        
        /* Chart legend style */
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
            gap: 15px;
            padding: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border-radius: 3px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* Stats boxes */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .stats-box {
            background-color: #E1F5FE;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-box h3 {
            font-size: 16px;
            margin-top: 0;
            margin-bottom: 10px;
            color: #01579B;
        }
        
        .stats-box p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        /* Key observations list */
        .observations {
            text-align: left;
            background-color: #F5F5F5;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .observations h3 {
            margin-top: 0;
            color: #00796B;
        }
        
        .observations ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        
        .observations li {
            margin-bottom: 5px;
        }
        
        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .forecast-toggle {
            display: flex;
            align-items: center;
            background-color: #E8F5E9;
            padding: 10px 15px;
            border-radius: 8px;
            margin-right: 10px;
        }
        
        .btn {
            background-color: #00796B;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn:hover {
            background-color: #00897B;
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00796B;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Data section */
        .data-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #F5F5F5;
            border-radius: 8px;
            text-align: left;
        }
        
        .data-section h3 {
            margin-top: 0;
            color: #00796B;
        }
        
        /* Forecast area styling */
        .forecast-info {
            background-color: #FFF8E1;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #FFB300;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .page-container {
                flex-direction: column;
            }
            
            .left-pane, .center-pane, .right-pane {
                width: 100%;
                border: none;
            }
            
            #chart-container {
                height: 300px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
    <script>
// Global error handler to catch JS errors
window.addEventListener('error', function(event) {
    console.error('Global error caught:', event.error);
    document.body.innerHTML += `
        <div style="position: fixed; top: 0; left: 0; right: 0; background-color: #ffebee; color: #b71c1c; 
                    padding: 20px; z-index: 9999; border-bottom: 2px solid #b71c1c">
            JavaScript Error: ${event.message} at ${event.filename}:${event.lineno}
        </div>
    `;
});

// Debug function to add status messages to the page
function debugStatus(message, isError = false) {
    const statusDiv = document.getElementById('debug-status') || (() => {
        const div = document.createElement('div');
        div.id = 'debug-status';
        div.style.position = 'fixed';
        div.style.bottom = '0';
        div.style.left = '0';
        div.style.right = '0';
        div.style.maxHeight = '200px';
        div.style.overflowY = 'auto';
        div.style.backgroundColor = '#f5f5f5';
        div.style.padding = '10px';
        div.style.zIndex = '9999';
        div.style.fontSize = '12px';
        div.style.fontFamily = 'monospace';
        document.body.appendChild(div);
        return div;
    })();
    
    const line = document.createElement('div');
    line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    line.style.color = isError ? '#b71c1c' : '#000';
    statusDiv.appendChild(line);
    statusDiv.scrollTop = statusDiv.scrollHeight;
    console.log(message);
}

document.addEventListener('DOMContentLoaded', function() {
    debugStatus('DOM fully loaded and parsed');
});
</script>
    // Add this script at the top of your HTML file, before any other scripts
<script>
// Global error handler to catch JS errors
window.addEventListener('error', function(event) {
    console.error('Global error caught:', event.error);
    document.body.innerHTML += `
        <div style="position: fixed; top: 0; left: 0; right: 0; background-color: #ffebee; color: #b71c1c; 
                    padding: 20px; z-index: 9999; border-bottom: 2px solid #b71c1c">
            JavaScript Error: ${event.message} at ${event.filename}:${event.lineno}
        </div>
    `;
});

// Debug function to add status messages to the page
function debugStatus(message, isError = false) {
    const statusDiv = document.getElementById('debug-status') || (() => {
        const div = document.createElement('div');
        div.id = 'debug-status';
        div.style.position = 'fixed';
        div.style.bottom = '0';
        div.style.left = '0';
        div.style.right = '0';
        div.style.maxHeight = '200px';
        div.style.overflowY = 'auto';
        div.style.backgroundColor = '#f5f5f5';
        div.style.padding = '10px';
        div.style.zIndex = '9999';
        div.style.fontSize = '12px';
        div.style.fontFamily = 'monospace';
        document.body.appendChild(div);
        return div;
    })();
    
    const line = document.createElement('div');
    line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    line.style.color = isError ? '#b71c1c' : '#000';
    statusDiv.appendChild(line);
    statusDiv.scrollTop = statusDiv.scrollHeight;
    console.log(message);
}

document.addEventListener('DOMContentLoaded', function() {
    debugStatus('DOM fully loaded and parsed');
});
</script>

// Replace the CSV loading part of your script with this enhanced version:
<script>
    // Function to load CSV data with better error handling
    function loadCSVData(forceRefresh) {
        debugStatus('Starting to load CSV data...');
        
        // Show loading indicator
        loadingIndicator.style.display = 'block';
        
        // Get the CSV path and add cache busting for forced refresh
       const csvPath = 'data/species/crab/trade_flow/crab_price_predictions_updated.csv';
        debugStatus(`Attempting to load CSV from: ${csvPath}`);
        
        const cacheBuster = forceRefresh ? `?cb=${new Date().getTime()}` : '';
        
        // Fetch CSV file
        fetch(csvPath + cacheBuster, { 
            cache: forceRefresh ? 'no-store' : 'default'
        })
        .then(response => {
            debugStatus(`Fetch response received - Status: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
                throw new Error(`Failed to load CSV file: ${response.status} ${response.statusText}`);
            }
            return response.text();
        })
        .then(csvText => {
            debugStatus(`CSV data received, length: ${csvText.length} chars`);
            
            if (csvText.length < 10) {
                debugStatus(`WARNING: CSV data seems too short: "${csvText}"`, true);
            }
            
            // Log first 100 chars for debugging
            debugStatus(`CSV preview: ${csvText.substring(0, 100).replace(/\n/g, '\\n')}`);
            
            // Parse CSV
            debugStatus('Parsing CSV data with PapaParse...');
            
            Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    debugStatus(`CSV parsed successfully. Found ${results.data.length} rows and ${results.meta.fields.length} columns`);
                    
                    // Log headers
                    debugStatus(`CSV Headers: ${results.meta.fields.join(', ')}`);
                    
                    // Check for expected columns
                    const requiredColumns = ['Dateyyymm', 'UBNL58_lb', 'New_Predicted_Price', 'New_Lower_CI', 'New_Upper_CI'];
                    const missingColumns = requiredColumns.filter(col => !results.meta.fields.includes(col));
                    
                    if (missingColumns.length > 0) {
                        debugStatus(`ERROR: Missing required columns: ${missingColumns.join(', ')}`, true);
                    }
                    
                    // Process the data
                    processData(results.data);
                    
                    // Hide loading indicator
                    loadingIndicator.style.display = 'none';
                },
                error: function(error) {
                    debugStatus(`ERROR parsing CSV: ${error}`, true);
                    showError(`Error parsing CSV: ${error}`);
                    loadingIndicator.style.display = 'none';
                }
            });
        })
        .catch(error => {
            debugStatus(`ERROR loading data: ${error.message}`, true);
            showError(`Error loading data: ${error.message}`);
            loadingIndicator.style.display = 'none';
            
            // Try an alternative approach for debugging - XHR
            debugStatus('Attempting alternative XHR approach for debugging...');
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', csvPath, true);
            xhr.onreadystatechange = function() {
                debugStatus(`XHR state change: readyState=${xhr.readyState}, status=${xhr.status}`);
                
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        debugStatus(`XHR SUCCESS: received ${xhr.responseText.length} chars`);
                    } else {
                        debugStatus(`XHR ERROR: ${xhr.status} ${xhr.statusText}`, true);
                    }
                }
            };
            xhr.send();
        });
    }
</script>
    <!-- Load Chart.js, PapaParse and Lodash -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
</head>
<body>
    <header>
        <h1>Seafood Datasearch</h1>
    </header>
    
    <div class="page-container">
        <!-- Left Pane - Logo and Tagline -->
        <div class="left-pane">
            <img src="assets/images/SD_Logo.png" alt="Seafood Datasearch Logo" class="logo">
            <div class="tagline">
                <h3>Market Analysis and Forecasts</h3>
                <p>Providing expert insights into the seafood industry.</p>
            </div>
        </div>
        
        <!-- Center Pane - Chart Content -->
        <div class="center-pane">
            <h2>Snow Crab Price Forecast Model</h2>
            <div class="chart-content">
                <h3>Price Model Historical Performance & Future Projections</h3>
                <p>This chart combines our model's historical accuracy with forecasted prices for upcoming periods based on our log-log regression model.</p>
                
                <!-- Forecast Info Box -->
                <div class="forecast-info">
                    <strong>Forecast Information:</strong>
                    <p>Projections are based on our proprietary log-log regression model incorporating trade volumes, production costs, exchange rates, and market factors. Future predictions use current variables and market expectations to forecast price trends.</p>
                </div>
                
                <!-- Controls Section -->
                <div class="controls">
                    <div>
                        <label class="forecast-toggle">
                            <input type="checkbox" id="show-forecast" checked>
                            <span style="margin-left: 5px;">Show Forecast</span>
                        </label>
                    </div>
                    <div>
                        <button id="refresh-btn" class="btn">Refresh Data</button>
                        <span id="last-updated"></span>
                    </div>
                </div>
                
                <!-- Loading indicator -->
                <div id="loading-indicator" style="display: none;">
                    <span class="loader"></span> Loading data...
                </div>
                
                <!-- Chart Container -->
                <div id="chart-container-wrapper">
                    <div class="chart-title">Snow Crab Price Model: Historical & Forecast (2019-2025)</div>
                    <div style="position: relative; height: 400px; width: 100%">
                        <canvas id="chart-container"></canvas>
                    </div>
                    <div id="chart-legend" class="chart-legend"></div>
                </div>
                
                <!-- Stats Boxes -->
                <div class="stats-container">
                    <div class="stats-box">
                        <h3>Model Performance</h3>
                        <p>Overall MAPE: 0.72%</p>
                        <p>Recent MAE: $0.62</p>
                        <p>Confidence Level: 95%</p>
                    </div>
                    <div class="stats-box">
                        <h3>Market Indicators</h3>
                        <p>Production: Stable</p>
                        <p>Inventory: Below Average</p>
                        <p>Demand: Increasing</p>
                    </div>
                    <div class="stats-box">
                        <h3>Forecast Summary</h3>
                        <p>Q1 2025: Steady Increase</p>
                        <p>Q2 2025: Potential Volatility</p>
                        <p>H2 2025: Stabilization</p>
                    </div>
                </div>
                
                <!-- Key Observations -->
                <div class="observations">
                    <h3>Key Market Insights:</h3>
                    <ul>
                        <li>Production capacity has stabilized following post-pandemic adjustments</li>
                        <li>CAD/USD exchange rate fluctuations are affecting import pricing</li>
                        <li>Seasonal demand patterns are returning to pre-2020 trends</li>
                        <li>New tariff structures are beginning to influence market anticipation</li>
                        <li>Restaurant demand has strengthened in line with broader economic recovery</li>
                    </ul>
                </div>
                
                <!-- Data Source Information -->
                <div class="data-section">
                    <h3>Data Sources & Model Information</h3>
                    <p>This forecast uses our proprietary log-log regression model with the following inputs:</p>
                    <ul>
                        <li>Canada-US trade volumes (log_CAUS_Total)</li>
                        <li>USD production cost (log_USD_Cost)</li>
                        <li>CAD/USD exchange rate (CADUSDEXCH)</li>
                        <li>Seasonal factors and market adjustments</li>
                        <li>Current tariff structure impacts (tariff_shock)</li>
                    </ul>
                    <p>Data source: Historical data from 2019-2024 trade records, with forecasts generated by our Model 3 regression analysis.</p>
                    <p>CSV data file: <code>model3_update.csv</code></p>
                </div>
            </div>
        </div>
        
        <!-- Right Pane - Navigation -->
        <div class="right-pane">
            <div class="nav-menu">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="crab_charts.html">Crab Charts</a></li>
                    <li><a href="snow_crab_price_model_historical_fit.html">Historical Model (2012-2024)</a></li>
                    <li><a href="recent_snow_crab_price_model.html">Recent Performance (2019-2024)</a></li>
                    <li><a href="lobster_charts.html">Lobster Charts</a></li>
                    <li><a href="shrimp_charts.html">Shrimp Charts</a></li>
                    <li><a href="salmon_charts.html">Salmon Charts</a></li>
                    <li><a href="forecast_models.html">Other Forecast Models</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="species-icons">
            <img src="assets/images/Lobster_icon.png" alt="Lobster">
            <img src="assets/images/shrimp_icon.png" alt="Shrimp">
            <img src="assets/images/crab_icon.png" alt="Crab">
            <img src="assets/images/salmon_icon.png" alt="Salmon">
        </div>
        <p>&copy; 2025 Seafood Datasearch. All rights reserved.</p>
        <script>
document.addEventListener('DOMContentLoaded', function() {
    // Create a status container
    const statusContainer = document.createElement('div');
    statusContainer.style.margin = '20px';
    statusContainer.style.padding = '20px';
    statusContainer.style.border = '1px solid #ccc';
    statusContainer.style.backgroundColor = '#f9f9f9';
    
    // Add a header
    const header = document.createElement('h3');
    header.textContent = 'CSV Loading Test';
    statusContainer.appendChild(header);
    
    // Add status output area
    const statusOutput = document.createElement('div');
    statusOutput.style.fontFamily = 'monospace';
    statusOutput.style.whiteSpace = 'pre-wrap';
    statusOutput.style.maxHeight = '300px';
    statusOutput.style.overflow = 'auto';
    statusOutput.style.marginTop = '10px';
    statusOutput.style.padding = '10px';
    statusOutput.style.backgroundColor = '#eee';
    statusContainer.appendChild(statusOutput);
    
    // Add to document
    document.body.appendChild(statusContainer);
    
    // Log function
    function log(message) {
        const line = document.createElement('div');
        line.textContent = message;
        statusOutput.appendChild(line);
        console.log(message);
    }
    
    // Test different path variations
    const pathsToTest = [
        'data/species/crab/trade_flow/crab_price_predictions_updated.csv',
        './data/species/crab/trade_flow/crab_price_predictions_updated.csv',
        '/data/species/crab/trade_flow/crab_price_predictions_updated.csv',
        'crab_price_predictions_updated.csv',
        '../data/species/crab/trade_flow/crab_price_predictions_updated.csv'
    ];
    
    log('Starting CSV path tests...');
    
    // Test each path
    pathsToTest.forEach(path => {
        log(`Testing path: ${path}`);
        
        fetch(path, { cache: 'no-store' })
            .then(response => {
                log(`Path ${path}: Status ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    log(`Path ${path}: FAILED - Not found or permission error`);
                    return null;
                }
                return response.text();
            })
            .then(text => {
                if (text) {
                    log(`Path ${path}: SUCCESS - Received ${text.length} characters`);
                    log(`Preview: ${text.substring(0, 100).replace(/\n/g, '\\n')}`);
                    
                    // Try to parse with PapaParse if available
                    if (window.Papa) {
                        try {
                            const results = Papa.parse(text, {
                                header: true,
                                skipEmptyLines: true
                            });
                            log(`Path ${path}: Parsed ${results.data.length} rows, headers: ${results.meta.fields.join(', ')}`);
                        } catch (e) {
                            log(`Path ${path}: Parse ERROR - ${e.message}`);
                        }
                    } else {
                        log('PapaParse not available for testing');
                    }
                }
            })
            .catch(error => {
                log(`Path ${path}: ERROR - ${error.message}`);
            });
    });
});
</script>
    </footer>
    
    <!-- Chart.js implementation -->
  

// Replace the entire <script> section at the bottom of the HTML with this enhanced version:

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Declare variables at higher scope
        let chart = null;
        let fullData = [];
        
        // Elements
        const showForecastCheckbox = document.getElementById('show-forecast');
        const refreshButton = document.getElementById('refresh-btn');
        const lastUpdatedSpan = document.getElementById('last-updated');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // Check if required libraries are loaded
        if (!window.Chart || !window.Papa || !window._) {
            document.getElementById('chart-container-wrapper').innerHTML = 
                '<div style="color: #cc0000; padding: 20px;">Error: One or more required libraries failed to load. Please check the console for details.</div>';
            console.error('Missing libraries:', {
                'Chart.js': !!window.Chart,
                'PapaParse': !!window.Papa,
                'Lodash': !!window._
            });
            return;
        }
        
        // Updated CSV file path
        const csvPath = 'data/species/crab/trade_flow/crab_price_predictions_updated.csv';
        
        // Event listeners
        showForecastCheckbox.addEventListener('change', function() {
            updateChartDisplay(fullData);
        });
        
        refreshButton.addEventListener('click', function() {
            loadCSVData(true);
        });
        
        // Initial data load
        loadCSVData(false);
        
        // Helper function to parse and normalize dates
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            try {
                if (dateStr.includes('/')) {
                    // Format like "1/1/19" or "1/1/2019"
                    const parts = dateStr.split('/');
                    if (parts.length >= 3) {
                        const month = parseInt(parts[0], 10);
                        const day = parseInt(parts[1], 10);
                        let year = parseInt(parts[2], 10);
                        
                        // Adjust 2-digit years
                        if (year < 100) {
                            year += 2000;
                        }
                        
                        // Return a date object for easy comparison
                        return new Date(year, month - 1, day);
                    }
                } else if (dateStr.includes('-')) {
                    // Format like "2019-01-01"
                    return new Date(dateStr);
                } else if (dateStr.toLowerCase().includes('na')) {
                    // Handle 'NA' values
                    return null;
                }
                
                // If we can't parse it, return null
                console.warn(`Could not parse date: ${dateStr}`);
                return null;
            } catch (e) {
                console.error(`Error parsing date '${dateStr}':`, e);
                return null;
            }
        }
        
        // Helper function to format dates for display
        function formatDateForDisplay(date) {
            if (!date) return '';
            
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const year = date.getFullYear().toString().substr(-2); // Get last 2 digits
            
            return `${month}/${day}/${year}`;
        }
        
        // Function to load CSV data
        function loadCSVData(forceRefresh) {
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            
            // Cache busting for forced refresh
            const cacheBuster = forceRefresh ? `?cb=${new Date().getTime()}` : '';
            
            // Fetch CSV file
            fetch(csvPath + cacheBuster, { 
                cache: forceRefresh ? 'no-store' : 'default'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to load CSV file: ${response.status} ${response.statusText}`);
                }
                return response.text();
            })
            .then(csvText => {
                // Add debugging info
                console.log("CSV loaded successfully. First 100 chars:", csvText.substring(0, 100));
                
                // Parse CSV
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Log headers for debugging
                        console.log("CSV headers:", results.meta.fields);
                        console.log("Total rows:", results.data.length);
                        console.log("First 3 rows:", results.data.slice(0, 3));
                        
                        // Update last updated timestamp
                        lastUpdatedSpan.textContent = `Last updated: ${new Date().toLocaleString()}`;
                        
                        // Process the data
                        processData(results.data);
                        
                        // Hide loading indicator
                        loadingIndicator.style.display = 'none';
                    },
                    error: function(error) {
                        showError(`Error parsing CSV: ${error}`);
                        loadingIndicator.style.display = 'none';
                    }
                });
            })
            .catch(error => {
                showError(`Error loading data: ${error.message}`);
                loadingIndicator.style.display = 'none';
            });
        }
        
        // Process the CSV data
        function processData(rawData) {
            try {
                // Store the full dataset
                fullData = rawData;
                
                // Add parsed date objects for easier filtering
                fullData.forEach(row => {
                    row._parsedDate = parseDate(row.Dateyyymm);
                });
                
                // Filter data to only include dates from 1/1/2020 to 12/1/2025
                const startDate = new Date(2020, 0, 1); // Jan 1, 2020
                const endDate = new Date(2025, 11, 1);  // Dec 1, 2025
                
                fullData = fullData.filter(row => {
                    if (!row._parsedDate) return false;
                    return row._parsedDate >= startDate && row._parsedDate <= endDate;
                });
                
                // Log how many rows were kept after filtering
                console.log(`Filtered data: ${fullData.length} rows remain after date filtering`);
                
                // Sort data by date to ensure proper ordering
                fullData = _.sortBy(fullData, row => row._parsedDate);
                
                // Update chart with processed data
                updateChartDisplay(fullData);
            } catch (err) {
                showError(`Error processing data: ${err.message}`);
                console.error("Full error:", err);
            }
        }
        
        // Update chart based on current display settings
        function updateChartDisplay(data) {
            // Determine if forecasts should be shown
            const showForecasts = showForecastCheckbox.checked;
            
            // Prepare data for Chart.js
            let chartData = {
                labels: [],
                datasets: [
                    {
                        label: 'Actual Price',
                        data: [],
                        borderColor: '#059669',
                        backgroundColor: '#059669',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Predicted Price',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: '#3b82f6',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Lower 95% Bound',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'transparent',
                        borderWidth: 1,
                        pointRadius: 0,
                        borderDash: [3, 3],
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Upper 95% Bound',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'transparent',
                        borderWidth: 1,
                        pointRadius: 0,
                        borderDash: [3, 3],
                        fill: '+1',
                        tension: 0.1
                    },
                    {
                        label: 'Confidence Interval',
                        data: [],
                        borderColor: 'transparent',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: '+1',
                        tension: 0.1,
                        pointRadius: 0
                    },
                    {
                        label: 'Forecast',
                        data: [],
                        borderColor: '#f97316', // Orange color for forecast
                        backgroundColor: '#f97316',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        borderDash: [8, 4],
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Forecast Lower Bound',
                        data: [],
                        borderColor: '#f97316',
                        backgroundColor: 'transparent',
                        borderWidth: 1,
                        pointRadius: 0,
                        borderDash: [3, 3],
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'Forecast Upper Bound',
                        data: [],
                        borderColor: '#f97316',
                        backgroundColor: 'transparent',
                        borderWidth: 1,
                        pointRadius: 0,
                        borderDash: [3, 3],
                        fill: '+1',
                        tension: 0.1
                    },
                    {
                        label: 'Forecast Confidence Interval',
                        data: [],
                        borderColor: 'transparent',
                        backgroundColor: 'rgba(249, 115, 22, 0.2)',
                        fill: '+1',
                        tension: 0.1,
                        pointRadius: 0
                    }
                ]
            };
            
            // Separate historical and forecast data
            let historicalData = [];
            let forecastData = [];
            
            data.forEach(row => {
                // Map the new column names to the expected variables
                const date = row.Dateyyymm;
                const formattedDate = formatDateForDisplay(row._parsedDate);
                const actual = row.UBNL58_lb;
                const predicted = row.New_Predicted_Price;
                const lowerBound = row.New_Lower_CI;
                const upperBound = row.New_Upper_CI;
                
                // Skip rows with missing critical data
                if (!date || !predicted || !lowerBound || !upperBound) {
                    console.warn("Skipping row with missing data:", row);
                    return;
                }
                
                // Check if this is historical or forecast data
                // Assume rows with actual values (not NA or null) are historical
                if (actual !== null && actual !== undefined && actual !== '' && 
                    actual !== 'NA' && !isNaN(parseFloat(actual))) {
                    // This is historical data
                    historicalData.push({
                        date: formattedDate, // Use the formatted date
                        rawDate: date,       // Keep original for debugging
                        actual: parseFloat(actual),
                        predicted: parseFloat(predicted),
                        lowerBound: parseFloat(lowerBound),
                        upperBound: parseFloat(upperBound)
                    });
                } else if (showForecasts) {
                    // This is forecast data and forecasts are enabled
                    forecastData.push({
                        date: formattedDate, // Use the formatted date
                        rawDate: date,       // Keep original for debugging
                        predicted: parseFloat(predicted),
                        lowerBound: parseFloat(lowerBound),
                        upperBound: parseFloat(upperBound)
                    });
                }
            });
            
            // Log data for debugging
            console.log(`Historical data points: ${historicalData.length}, Forecast data points: ${forecastData.length}`);
            if (historicalData.length > 0) {
                console.log("First historical point:", historicalData[0]);
                console.log("Last historical point:", historicalData[historicalData.length - 1]);
            }
            if (forecastData.length > 0) {
                console.log("First forecast point:", forecastData[0]);
                console.log("Last forecast point:", forecastData[forecastData.length - 1]);
            }
            
            // Sort data by date
            historicalData = _.sortBy(historicalData, item => item.date);
            forecastData = _.sortBy(forecastData, item => item.date);
            
            // Populate chart data for historical values
            chartData.labels = historicalData.map(item => item.date);
            chartData.datasets[0].data = historicalData.map(item => item.actual);
            chartData.datasets[1].data = historicalData.map(item => item.predicted);
            chartData.datasets[2].data = historicalData.map(item => item.lowerBound);
            chartData.datasets[3].data = historicalData.map(item => item.upperBound);
            chartData.datasets[4].data = historicalData.map(item => item.lowerBound);
            
            // Add forecast data if enabled
            if (showForecasts && forecastData.length > 0) {
                // Add to labels
                chartData.labels = chartData.labels.concat(forecastData.map(item => item.date));
                
                // Add null values for actual prices in forecast period
                chartData.datasets[0].data = chartData.datasets[0].data.concat(
                    forecastData.map(() => null)
                );
                
                // Add null values for historical prediction lines in forecast period
                chartData.datasets[1].data = chartData.datasets[1].data.concat(
                    forecastData.map(() => null)
                );
                chartData.datasets[2].data = chartData.datasets[2].data.concat(
                    forecastData.map(() => null)
                );
                chartData.datasets[3].data = chartData.datasets[3].data.concat(
                    forecastData.map(() => null)
                );
                chartData.datasets[4].data = chartData.datasets[4].data.concat(
                    forecastData.map(() => null)
                );
                
                // Add forecast data
                // First add null values for historical period
                chartData.datasets[5].data = historicalData.map(() => null);
                chartData.datasets[6].data = historicalData.map(() => null);
                chartData.datasets[7].data = historicalData.map(() => null);
                chartData.datasets[8].data = historicalData.map(() => null);
                
                // Then add the forecast values
                chartData.datasets[5].data = chartData.datasets[5].data.concat(
                    forecastData.map(item => item.predicted)
                );
                chartData.datasets[6].data = chartData.datasets[6].data.concat(
                    forecastData.map(item => item.lowerBound)
                );
                chartData.datasets[7].data = chartData.datasets[7].data.concat(
                    forecastData.map(item => item.upperBound)
                );
                chartData.datasets[8].data = chartData.datasets[8].data.concat(
                    forecastData.map(item => item.lowerBound)
                );
            }
            
            // Create or update the chart
            createChart(chartData);
        }
        
        function createChart(data) {
            const ctx = document.getElementById('chart-container').getContext('2d');
            
            // Clean up existing chart if it exists
            if (chart) {
                chart.destroy();
            }
            
            // Create annotations for forecast section
            const annotations = {};
            
            // If there are forecast values, add a vertical line and region
            if (showForecastCheckbox.checked && data.datasets[5].data.findIndex(v => v !== null) >= 0) {
                // Find the index where forecasts begin
                const forecastStartIndex = data.datasets[5].data.findIndex(v => v !== null);
                
                if (forecastStartIndex > 0) {
                    // Add vertical line annotation
                    annotations.forecastLine = {
                        type: 'line',
                        xMin: forecastStartIndex - 0.5,
                        xMax: forecastStartIndex - 0.5,
                        borderColor: '#f97316',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        label: {
                            content: 'Forecast Start',
                            enabled: true,
                            position: 'top'
                        }
                    };
                    
                    // Add box annotation for forecast region
                    annotations.forecastRegion = {
                        type: 'box',
                        xMin: forecastStartIndex - 0.5,
                        xMax: data.labels.length,
                        backgroundColor: 'rgba(255, 236, 179, 0.2)',
                        borderColor: 'rgba(255, 152, 0, 0.2)',
                        borderWidth: 0
                    };
                }
            }
            
            // Get the maximum y-value for proper scaling
            const allValues = []
                .concat(data.datasets[0].data.filter(v => v !== null))
                .concat(data.datasets[1].data.filter(v => v !== null))
                .concat(data.datasets[3].data.filter(v => v !== null)) // upper bound
                .concat(data.datasets[5].data.filter(v => v !== null)) // forecast
                .concat(data.datasets[7].data.filter(v => v !== null)); // forecast upper bound
            
            const maxValue = Math.max(...allValues) * 1.1; // Add 10% margin
            
            // Create the chart
            chart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: maxValue,
                            title: {
                                display: true,
                                text: 'Price ($/lb)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: annotations
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (label === 'Confidence Interval' || label === 'Forecast Confidence Interval') {
                                        return null; // Don't show these in tooltip
                                    }
                                    if (value === null || value === undefined) {
                                        return null;
                                    }
                                    return label + ': $' + value.toFixed(2);
                                }
                            }
                        },
                        legend: {
                            display: false // We'll use custom legend
                        }
                    }
                }
            });
            
            // Create custom legend
            createCustomLegend(data.datasets);
        }
        
        function createCustomLegend(datasets) {
            const legendContainer = document.getElementById('chart-legend');
            legendContainer.innerHTML = '';
            
            // Create legend items for the primary data series only (not the confidence intervals)
            const legendItems = [
                { label: 'Actual Price', color: '#059669' },
                { label: 'Predicted Price', color: '#3b82f6' },
                { label: '95% Confidence Interval', color: 'rgba(59, 130, 246, 0.2)' },
                { label: 'Price Forecast', color: '#f97316' },
                { label: 'Forecast Confidence Interval', color: 'rgba(249, 115, 22, 0.2)' }
            ];
            
            legendItems.forEach(item => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = item.color;
                
                const label = document.createElement('span');
                label.textContent = item.label;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                legendContainer.appendChild(legendItem);
            });
        }
        
        // Error display function
        function showError(message) {
            console.error(message);
            document.getElementById('chart-container-wrapper').innerHTML = 
                `<div style="color: #cc0000; padding: 20px;">${message}</div>`;
        }
    });
</script>
<script>
(function() {
  // Create test container
  var container = document.createElement('div');
  container.style.position = 'fixed';
  container.style.bottom = '0';
  container.style.left = '0';
  container.style.right = '0';
  container.style.padding = '10px';
  container.style.backgroundColor = '#f5f5f5';
  container.style.zIndex = '9999';
  container.style.maxHeight = '200px';
  container.style.overflow = 'auto';
  container.style.borderTop = '1px solid #ccc';
  
  // Add a heading
  var heading = document.createElement('h4');
  heading.textContent = 'CSV Path Test';
  heading.style.margin = '0 0 10px 0';
  container.appendChild(heading);
  
  // Add log area
  var logArea = document.createElement('div');
  logArea.style.fontFamily = 'monospace';
  logArea.style.fontSize = '12px';
  container.appendChild(logArea);
  
  // Add to document
  document.body.appendChild(container);
  
  // Log function
  function log(message) {
    var line = document.createElement('div');
    line.textContent = message;
    logArea.appendChild(line);
    console.log(message);
  }
  
  // Test paths
  var paths = [
    'data/species/crab/trade_flow/crab_price_predictions_updated.csv',
    './data/species/crab/trade_flow/crab_price_predictions_updated.csv',
    '/data/species/crab/trade_flow/crab_price_predictions_updated.csv',
    'crab_price_predictions_updated.csv'
  ];
  
  log('Testing CSV paths...');
  
  // Test each path
  paths.forEach(function(path) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', path, true);
    
    xhr.onload = function() {
      if (xhr.status === 200) {
        log('SUCCESS: ' + path + ' - ' + xhr.responseText.length + ' bytes');
      } else {
        log('FAILED: ' + path + ' - Status: ' + xhr.status);
      }
    };
    
    xhr.onerror = function() {
      log('ERROR: ' + path + ' - Network error');
    };
    
    xhr.send();
  });
})();
</script>