<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snow Crab Price Forecast with Tariff - Seafood Datasearch</title>
    <style>
        body {
            font-family: "Arial", sans-serif;
            background-color: #E0F2F1;
            margin: 0;
            padding: 0;
        }
        
        header {
            padding: 20px;
            text-align: center;
            background-color: #B2DFDB;
        }
        
        .page-container {
            display: flex;
            min-height: calc(100vh - 200px);
        }
        
        .left-pane {
            flex: 1;
            padding: 20px;
            background-color: #E0F2F1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #B2DFDB;
        }
        
        .center-pane {
            flex: 2;
            padding: 20px;
            background-color: #FFFFFF;
            text-align: center;
        }
        
        .right-pane {
            flex: 1;
            padding: 20px;
            background-color: #E0F2F1;
            border-left: 1px solid #B2DFDB;
        }
        
        .logo {
            width: 90%;
            max-width: 300px;
            height: auto;
            margin-bottom: 20px;
        }
        
        .tagline {
            font-style: italic;
            color: #00796B;
            text-align: center;
        }
        
        .chart-content {
            background-color: #F5F5F5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-menu {
            background-color: #F5F5F5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-menu ul {
            list-style-type: none;
            padding: 0;
        }
        
        .nav-menu li {
            margin: 10px 0;
        }
        
        .nav-menu a {
            text-decoration: none;
            color: #00796B;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
            display: block;
        }
        
        .nav-menu a:hover {
            background-color: #B2DFDB;
        }
        
        .species-icons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            padding: 10px;
        }
        
        .species-icons img {
            width: 80px;
            height: auto;
        }
        
        footer {
            padding: 20px;
            background-color: #B2DFDB;
            text-align: center;
        }
        
        /* Chart container styles */
        .chart-container {
            height: 400px;
            margin-top: 20px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
            gap: 15px;
            padding: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border-radius: 3px;
        }
        
        .highlight-box {
            background-color: #ffeeba;
            border-left: 4px solid #d39e00;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 4px 4px 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .page-container {
                flex-direction: column;
            }
            
            .left-pane, .center-pane, .right-pane {
                width: 100%;
                border: none;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
    
    <!-- Load Chart.js and PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
    <header>
        <h1>Seafood Datasearch</h1>
    </header>
    
    <div class="page-container">
        <!-- Left Pane - Logo and Tagline -->
        <div class="left-pane">
            <img src="assets/images/SD_Logo.png" alt="Seafood Datasearch Logo" class="logo">
            <div class="tagline">
                <h3>Market Analysis and Forecasts</h3>
                <p>Providing expert insights into the seafood industry.</p>
            </div>
        </div>
        
        <!-- Center Pane - Chart Content -->
        <div class="center-pane">
            <h2>Snow Crab Price Forecast with Tariff</h2>
            <div class="chart-content">
                <h3>Market Price Analysis with Tariff Impact</h3>
                <p>Our statistical model forecasts snow crab wholesale prices with the addition of a projected 20% market price increase due to tariffs.</p>
                
                <!-- Chart Container -->
                <div>
                    <div class="chart-title">Snow Crab Price Model with Tariff: Historical & Forecast (2020-2025)</div>
                    <div class="chart-container">
                        <canvas id="chart-canvas"></canvas>
                    </div>
                    <div id="chart-legend" class="chart-legend"></div>
                </div>
                
                <div class="highlight-box">
                    <strong>Simplified Tariff Impact Model:</strong> This forecast assumes a flat 20% increase in market prices starting from March 2025 when tariffs are implemented. The model accounts for anticipated price adjustments due to market demand changes in response to the tariff.
                </div>
            </div>
            
            <div class="chart-content">
                <h3>Tariff Forecast Explanation</h3>
                <p>This forecast shows the snow crab market expectations with a 20% price increase due to the implementation of tariffs. This simplified model applies the tariff percentage directly to the baseline forecast prices from March 2025 onward.</p>
                <p>This model is based on an assumption that most of the price increase from Nov to Feb was based on anticipatory buying in the event of tariffs, meaning that tariffs are already priced in. Our two models, with and without tariffs, assume that if tariffs are not applied and appear off the table, prices will revert to a more normal scenario. But if tariffs apply, prices will be higher, but the market will begin adjusting to potentially reduced demand, so increased volume will push prices lower.</p>
                <p>View our <a href="https://seafooddatasearch.com/snow_crab_price_forecast.html">baseline forecast without tariffs</a> for comparison.</p>
            </div>
            
            <div class="chart-content">
                <h3>About This Data</h3>
                <p>This forecast is derived from our baseline snow crab price model with a straightforward 20% increase applied to prices from March 2025 through December 2025 to represent the tariff impact. The confidence intervals are similarly adjusted.</p>
                <p>Data source: NMFS, DFO, and trade flow data from U.S. and Canadian markets (2020-2025) with tariff markup calculations</p>
            </div>
        </div>
        
        <!-- Right Pane - Navigation -->
        <div class="right-pane">
            <div class="nav-menu">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="crab_charts.html">Crab Charts</a></li>
                    <li><a href="lobster_charts.html">Lobster Charts</a></li>
                    <li><a href="shrimp_charts.html">Shrimp Charts</a></li>
                    <li><a href="salmon_charts.html">Salmon Charts</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="species-icons">
            <img src="assets/images/Lobster_icon.png" alt="Lobster">
            <img src="assets/images/shrimp_icon.png" alt="Shrimp">
            <img src="assets/images/crab_icon.png" alt="Crab">
            <img src="assets/images/salmon_icon.png" alt="Salmon">
        </div>
        <p>&copy; 2025 Seafood Datasearch. All rights reserved.</p>
    </footer>
    
    <!-- Chart.js implementation -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Variables
            let chart = null;
            const csvPath = './data/species/crab/trade_flow/crab_price_predictions_updated.csv';
            const tariffStartDate = new Date(2025, 2, 1); // March 1, 2025
            const tariffMultiplier = 1.20; // 20% increase
            
            // Load CSV data
            Papa.parse(csvPath, {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    // Process data - Filter for date range 2020-2025
                    let processedData = filterDataByDateRange(results.data);
                    
                    // Apply tariff calculation
                    processedData = applyTariffCalculation(processedData);
                    
                    // Create chart
                    createChart(processedData);
                },
                error: function(error) {
                    console.error('ERROR parsing CSV:', error);
                    document.querySelector('.chart-container').innerHTML = 
                        '<div style="color: red; padding: 20px;">Error loading data. Please try again later.</div>';
                }
            });
            
            // Filter data by date range
            function filterDataByDateRange(data) {
                // Setup for date filtering
                const filteredData = [];
                const startDate = new Date(2020, 0, 1); // Jan 1, 2020
                const endDate = new Date(2025, 11, 31); // Dec 31, 2025
                
                console.log('Filtering data between', startDate.toISOString(), 'and', endDate.toISOString());
                
                // Convert dates and filter
                data.forEach(row => {
                    const dateStr = row.Dateyyymm;
                    if (!dateStr) return;
                    
                    try {
                        // Parse date
                        let year, month, day;
                        
                        if (dateStr.includes('/')) {
                            // Format MM/DD/YY
                            const parts = dateStr.split('/');
                            month = parseInt(parts[0], 10);
                            day = parseInt(parts[1], 10) || 1; // Default to 1st if day not provided
                            year = parseInt(parts[2], 10);
                            
                            // Adjust 2-digit year
                            if (year < 100) {
                                year += 2000;
                            }
                            
                            // Create a date object
                            const date = new Date(year, month - 1, day);
                            
                            // Check if in range
                            if (date >= startDate && date <= endDate) {
                                // Add parsed date to row for sorting
                                row._parsedDate = date;
                                filteredData.push(row);
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing date:', dateStr, e.message);
                    }
                });
                
                // Sort by date
                filteredData.sort((a, b) => a._parsedDate - b._parsedDate);
                
                console.log('Filtered data count:', filteredData.length);
                // Log a few data points to verify dates
                filteredData.slice(0, 3).forEach(row => {
                    console.log('Sample date:', row.Dateyyymm, 'Parsed date:', row._parsedDate.toISOString());
                });
                
                // Log items from 2025 to ensure we have future dates
                const items2025 = filteredData.filter(row => row._parsedDate.getFullYear() === 2025);
                console.log('2025 data points:', items2025.length);
                items2025.slice(0, 5).forEach(row => {
                    console.log('2025 date:', row.Dateyyymm, 'Parsed:', row._parsedDate.toISOString());
                });
                
                return filteredData;
            }
            
            // Apply tariff calculation to forecast data
            function applyTariffCalculation(data) {
                // Create a deep copy to avoid modifying the original data
                const tariffData = JSON.parse(JSON.stringify(data));
                
                // Log the tariff start date for debugging
                console.log('Tariff start date:', tariffStartDate.toISOString());
                
                // For each row in the data
                tariffData.forEach(row => {
                    // Make sure dates are properly compared as Date objects
                    const rowDate = new Date(row._parsedDate);
                    
                    // Debug log for a few rows
                    if (rowDate.getFullYear() === 2025) {
                        console.log('Row date:', rowDate.toISOString(), 
                                   'Is after tariff date:', rowDate >= tariffStartDate,
                                   'Month:', rowDate.getMonth() + 1,
                                   'Original price:', row.New_Predicted_Price);
                    }
                    
                    // If the date is after tariff implementation and it's a forecast row (no actual price)
                    if (rowDate >= tariffStartDate && (!row.UBNL58_lb || row.UBNL58_lb === 'NA')) {
                        // Apply tariff multiplier to predicted price and confidence intervals
                        if (row.New_Predicted_Price) {
                            row.Tariff_Predicted_Price = parseFloat((row.New_Predicted_Price * tariffMultiplier).toFixed(2));
                            // Debug log
                            if (rowDate.getFullYear() === 2025) {
                                console.log('Applied tariff:', row.Tariff_Predicted_Price);
                            }
                        } else {
                            row.Tariff_Predicted_Price = null;
                        }
                        
                        if (row.New_Lower_CI) {
                            row.Tariff_Lower_CI = parseFloat((row.New_Lower_CI * tariffMultiplier).toFixed(2));
                        } else {
                            row.Tariff_Lower_CI = null;
                        }
                        
                        if (row.New_Upper_CI) {
                            row.Tariff_Upper_CI = parseFloat((row.New_Upper_CI * tariffMultiplier).toFixed(2));
                        } else {
                            row.Tariff_Upper_CI = null;
                        }
                    } else {
                        // For historical data or pre-tariff forecast, keep original values
                        row.Tariff_Predicted_Price = row.New_Predicted_Price;
                        row.Tariff_Lower_CI = row.New_Lower_CI;
                        row.Tariff_Upper_CI = row.New_Upper_CI;
                    }
                });
                
                return tariffData;
            }
            
            // Create the chart
            function createChart(data) {
                // Split data into historical (actual prices exist) and forecast
                const historicalData = [];
                const forecastData = [];
                const tariffData = [];
                
                console.log('Total data rows:', data.length);
                // Find index where tariff implementation begins
                const tariffDateIndex = data.findIndex(row => {
                    const rowDate = new Date(row._parsedDate);
                    return rowDate >= tariffStartDate;
                });
                console.log('Tariff date index:', tariffDateIndex);
                
                // Sort data into appropriate categories
                data.forEach((row, index) => {
                    const rowDate = new Date(row._parsedDate);
                    
                    if (row.UBNL58_lb && row.UBNL58_lb !== 'NA') {
                        // Historical data (actual prices exist)
                        historicalData.push(row);
                    } else if (rowDate < tariffStartDate) {
                        // Forecast data before tariff implementation
                        forecastData.push(row);
                    } else {
                        // Forecast data after tariff implementation
                        tariffData.push(row);
                    }
                });
                
                console.log('Historical data:', historicalData.length);
                console.log('Forecast data (pre-tariff):', forecastData.length);
                console.log('Tariff forecast data:', tariffData.length);
                
                // Format dates for display
                const formatDate = function(date) {
                    const d = new Date(date);
                    return `${d.getMonth() + 1}/${d.getFullYear().toString().substr(-2)}`;
                };
                
                // Setup chart data
                const chartData = {
                    labels: [...historicalData.map(r => formatDate(r._parsedDate)), 
                             ...forecastData.map(r => formatDate(r._parsedDate)),
                             ...tariffData.map(r => formatDate(r._parsedDate))],
                    datasets: [
                        {
                            label: 'Actual Price',
                            data: [...historicalData.map(r => r.UBNL58_lb), 
                                   ...forecastData.map(() => null),
                                   ...tariffData.map(() => null)],
                            borderColor: '#059669',
                            backgroundColor: '#059669',
                            borderWidth: 2,
                            pointRadius: 4,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Predicted Price (Historical)',
                            data: [...historicalData.map(r => r.New_Predicted_Price), 
                                   ...forecastData.map(() => null),
                                   ...tariffData.map(() => null)],
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f6',
                            borderWidth: 2,
                            pointRadius: 4,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Forecast (No Tariff)',
                            data: [...historicalData.map(() => null), 
                                   ...forecastData.map(r => r.New_Predicted_Price),
                                   ...tariffData.map(r => r.New_Predicted_Price)],
                            borderColor: '#f97316',
                            backgroundColor: '#f97316',
                            borderWidth: 2,
                            pointRadius: 4,
                            borderDash: [8, 4],
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Forecast with Tariff',
                            data: [...historicalData.map(() => null), 
                                   ...forecastData.map(() => null),
                                   ...tariffData.map(r => r.Tariff_Predicted_Price)],
                            borderColor: '#dc2626',
                            backgroundColor: '#dc2626',
                            borderWidth: 2,
                            pointRadius: 4,
                            borderDash: [8, 4],
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Confidence Interval (Historical)',
                            data: [...historicalData.map(r => r.New_Lower_CI), 
                                   ...forecastData.map(() => null),
                                   ...tariffData.map(() => null)],
                            borderColor: 'transparent',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: '+1',
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Upper 95% Bound (Historical)',
                            data: [...historicalData.map(r => r.New_Upper_CI), 
                                   ...forecastData.map(() => null),
                                   ...tariffData.map(() => null)],
                            borderColor: '#3b82f6',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            pointRadius: 0,
                            borderDash: [3, 3],
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Lower 95% Bound (Historical)',
                            data: [...historicalData.map(r => r.New_Lower_CI), 
                                   ...forecastData.map(() => null),
                                   ...tariffData.map(() => null)],
                            borderColor: '#3b82f6',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            pointRadius: 0,
                            borderDash: [3, 3],
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Lower 95% Bound (No Tariff)',
                            data: [...historicalData.map(() => null), 
                                   ...forecastData.map(r => r.New_Lower_CI),
                                   ...tariffData.map(r => r.New_Lower_CI)],
                            borderColor: '#f97316',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            pointRadius: 0,
                            borderDash: [3, 3],
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Upper 95% Bound (No Tariff)',
                            data: [...historicalData.map(() => null), 
                                   ...forecastData.map(r => r.New_Upper_CI),
                                   ...tariffData.map(r => r.New_Upper_CI)],
                            borderColor: '#f97316',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            pointRadius: 0,
                            borderDash: [3, 3],
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Confidence Interval (No Tariff)',
                            data: [...historicalData.map(() => null), 
                                   ...forecastData.map(r => r.New_Lower_CI),
                                   ...tariffData.map(r => r.New_Lower_CI)],
                            borderColor: 'transparent',
                            backgroundColor: 'rgba(249, 115, 22, 0.2)',
                            fill: '+1',
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower 95% Bound (Tariff)',
                            data: [...historicalData.map(() => null), 
                                   ...forecastData.map(() => null),
                                   ...tariffData.map(r => r.Tariff_Lower_CI)],
                            borderColor: '#dc2626',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            pointRadius: 0,
                            borderDash: [3, 3],
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Upper 95% Bound (Tariff)',
                            data: [...historicalData.map(() => null), 
                                   ...forecastData.map(() => null),
                                   ...tariffData.map(r => r.Tariff_Upper_CI)],
                            borderColor: '#dc2626',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            pointRadius: 0,
                            borderDash: [3, 3],
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Confidence Interval (Tariff)',
                            data: [...historicalData.map(() => null), 
                                   ...forecastData.map(() => null),
                                   ...tariffData.map(r => r.Tariff_Lower_CI)],
                            borderColor: 'transparent',
                            backgroundColor: 'rgba(220, 38, 38, 0.2)',
                            fill: '+1',
                            tension: 0.1,
                            pointRadius: 0
                        }
                    ]
                };
                
                // Render the chart
                const ctx = document.getElementById('chart-canvas').getContext('2d');
                
                chart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Price ($/lb)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toFixed(2);
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // Use custom legend instead
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        if (label.includes('Confidence Interval') || 
                                            label.includes('95% Bound')) {
                                            return null; // Don't show these in tooltip
                                        }
                                        if (value === null || value === undefined) {
                                            return null;
                                        }
                                        return label + ': $' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        afterDraw: function(chart) {
                            // Add tariff implementation annotation
                            const ctx = chart.ctx;
                            const xAxis = chart.scales.x;
                            const yAxis = chart.scales.y;
                            
                            // Calculate position for tariff date marker
                            // Find the month and year that matches our tariff start date
                            const tariffMonthStr = `${tariffStartDate.getMonth() + 1}/${tariffStartDate.getFullYear().toString().substr(-2)}`;
                            const tariffLabelIndex = chartData.labels.indexOf(tariffMonthStr);
                            console.log('Tariff label:', tariffMonthStr, 'Index:', tariffLabelIndex);
                            
                            if (tariffLabelIndex >= 0 && chart.getDatasetMeta(0).data[tariffLabelIndex]) {
                                const xPosition = chart.getDatasetMeta(0).data[tariffLabelIndex].x;
                                
                                // Draw vertical line
                                ctx.save();
                                ctx.beginPath();
                                ctx.moveTo(xPosition, yAxis.top);
                                ctx.lineTo(xPosition, yAxis.bottom);
                                ctx.lineWidth = 2;
                                ctx.strokeStyle = 'rgba(220, 53, 69, 0.7)';
                                ctx.setLineDash([5, 5]);
                                ctx.stroke();
                                
                                // Draw label
                                ctx.fillStyle = 'rgba(220, 53, 69, 1)';
                                ctx.font = '12px Arial';
                                ctx.textAlign = 'center';
                                ctx.fillText('Tariff Implementation', xPosition, yAxis.top - 10);
                                ctx.restore();
                            }
                        }
                    }]
                });
                
                // Create custom legend
                createCustomLegend();
            }
            
            // Create custom legend
            function createCustomLegend() {
                const legendContainer = document.getElementById('chart-legend');
                legendContainer.innerHTML = '';
                
                const legendItems = [
                    { label: 'Actual Price', color: '#059669' },
                    { label: 'Predicted Price (Historical)', color: '#3b82f6' },
                    { label: 'Forecast (No Tariff)', color: '#f97316' },
                    { label: 'Forecast with 20% Tariff', color: '#dc2626' },
                    { label: '95% Confidence Interval', color: 'rgba(59, 130, 246, 0.2)' }
                ];
                
                legendItems.forEach(item => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    
                    const colorBox = document.createElement('div');
                    colorBox.className = 'legend-color';
                    colorBox.style.backgroundColor = item.color;
                    
                    const label = document.createElement('span');
                    label.textContent = item.label;
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(label);
                    legendContainer.appendChild(legendItem);
                });
            }
        });
    </script>
</body>
</html>