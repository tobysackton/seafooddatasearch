<!DOCTYPE html>
<html lang="en">
<head>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6539VRG29E"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-6539VRG29E');
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canada Crab Exports to US - Seafood Datasearch</title>
    <link rel="stylesheet" href="assets/style.css">
    <style>
        body {
            font-family: "Arial", sans-serif;
            background-color: #E0F2F1; /* Very light sea green */
            margin: 0;
            padding: 0;
        }
        
        header {
            padding: 20px;
            text-align: center;
            background-color: #B2DFDB; /* Slightly darker sea green for header */
        }
        
        .page-container {
            display: flex;
            min-height: calc(100vh - 200px); /* Adjust based on header and footer height */
        }
        
        .left-pane {
            flex: 1;
            padding: 20px;
            background-color: #E0F2F1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #B2DFDB;
        }
        
        .center-pane {
            flex: 2;
            padding: 20px;
            background-color: #FFFFFF;
            text-align: center;
        }
        
        .right-pane {
            flex: 1;
            padding: 20px;
            background-color: #E0F2F1;
            border-left: 1px solid #B2DFDB;
        }
        
        .logo {
            width: 90%;
            max-width: 300px;
            height: auto;
            margin-bottom: 20px;
        }
        
        .tagline {
            font-style: italic;
            color: #00796B;
            text-align: center;
        }
        
        .chart-content {
            background-color: #F5F5F5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-menu {
            background-color: #F5F5F5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-menu ul {
            list-style-type: none;
            padding: 0;
        }
        
        .nav-menu li {
            margin: 10px 0;
        }
        
        .nav-menu a {
            text-decoration: none;
            color: #00796B;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
            display: block;
        }
        
        .nav-menu a:hover {
            background-color: #B2DFDB;
        }
        
        .species-icons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            padding: 10px;
        }
        
        .species-icons img {
            width: 80px;
            height: auto;
        }
        
        footer {
            padding: 20px;
            background-color: #B2DFDB;
            text-align: center;
        }
        
        /* Chart container styles */
        #chart-container-wrapper {
            width: 100%;
            margin-top: 20px;
        }
        
        #chart-container {
            height: 400px;
            width: 100%;
        }
        
        /* Chart legend style */
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
            gap: 15px;
            padding: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border-radius: 3px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .page-container {
                flex-direction: column;
            }
            
            .left-pane, .center-pane, .right-pane {
                width: 100%;
                border: none;
            }
            
            #chart-container {
                height: 300px;
            }
        }
    </style>
    
    <!-- Load Chart.js and PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
</head>
<body>
    <header>
        <h1>Seafood Datasearch</h1>
    </header>
    
    <div class="page-container">
        <!-- Left Pane - Logo and Tagline -->
        <div class="left-pane">
            <img src="assets/images/SD_Logo.png" alt="Seafood Datasearch Logo" class="logo">
            <div class="tagline">
                <h3>Market Analysis and Forecasts</h3>
                <p>Providing expert insights into the seafood industry.</p>
            </div>
        </div>
        
        <!-- Center Pane - Chart Content -->
        <div class="center-pane">
            <h2>Canada Crab Exports to US</h2>
            <div class="chart-content">
                <h3>Canada Market Share & Export Volume (2012-2024)</h3>
                <p>This visualization shows Canada's snow crab exports to the US and its market share percentage.</p>
                
                <!-- Chart Container -->
                <div id="chart-container-wrapper">
                    <div class="chart-title">Canada Snow Crab Exports to US (2012-2024)</div>
                    <div style="position: relative; height: 400px; width: 100%">
                        <canvas id="chart-container"></canvas>
                    </div>
                    <div id="chart-legend" class="chart-legend"></div>
                </div>
            </div>
            
            <div class="chart-content">
                <h3>About This Data</h3>
                <p>This chart displays Canada's snow crab export volumes to the United States alongside its market share percentage. The stacked bars show export volumes from Canada, Russia, and Norway in millions of pounds. The green line represents Canada's percentage share of total US crab imports.</p>
                <p>Data source: Trade flow data from US, Canada, Norway, and Russia (2012-2024)</p>
            </div>
        </div>
        
        <!-- Right Pane - Navigation -->
        <div class="right-pane">
            <div class="nav-menu">
                <h3>Navigation</h3>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="crab_charts.html">Crab Charts</a></li>
                    <li><a href="lobster_charts.html">Lobster Charts</a></li>
                    <li><a href="newfoundland_snow_crab_2025.html">Newfoundland Snow Crab</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="species-icons">
            <img src="assets/images/Lobster_icon.png" alt="Lobster">
            <img src="assets/images/shrimp_icon.png" alt="Shrimp">
            <img src="assets/images/crab_icon.png" alt="Crab">
            <img src="assets/images/salmon_icon.png" alt="Salmon">
        </div>
        <p>&copy; 2025 Seafood Datasearch. All rights reserved.</p>
    </footer>
    
    <!-- Chart.js implementation -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Declare variables at higher scope
            let chart = null;
            
            // Check if required libraries are loaded
            if (!window.Chart || !window.Papa || !window._) {
                document.getElementById('chart-container-wrapper').innerHTML = 
                    '<div style="color: #cc0000; padding: 20px;">Error: One or more required libraries failed to load. Please check the console for details.</div>';
                console.error('Missing libraries:', {
                    'Chart.js': !!window.Chart,
                    'PapaParse': !!window.Papa,
                    'Lodash': !!window._
                });
                return;
            }
            
            // Show loading indicator
            const chartContainer = document.getElementById('chart-container-wrapper');
            const loadingDiv = document.createElement('div');
            loadingDiv.style.cssText = 'display: flex; justify-content: center; align-items: center; height: 200px;';
            loadingDiv.textContent = 'Loading crab import data...';
            chartContainer.appendChild(loadingDiv);
            
            // Load and process CSV data
            loadData();
            
            async function loadData() {
                try {
                    // Path to the CSV file
                    const csvPath = 'data/species/crab/trade_flow/tradeflow_US_CA_Ch_JP_start_yr2000.csv';
                    
                    // Fetch the CSV file
                    const response = await fetch(csvPath);
                    if (!response.ok) {
                        throw new Error(`Failed to load CSV file: ${response.status} ${response.statusText}`);
                    }
                    
                    const csvText = await response.text();
                    
                    // Parse CSV using PapaParse
                    Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            // Remove loading indicator
                            if (loadingDiv && loadingDiv.parentNode) {
                                loadingDiv.parentNode.removeChild(loadingDiv);
                            }
                            processData(results.data);
                        },
                        error: (error) => {
                            showError(`Error parsing CSV: ${error}`);
                        }
                    });
                } catch (err) {
                    showError(`Error loading data: ${err.message}`);
                }
            }
            
            function processData(rawData) {
                try {
                    // Parse dates and add year property
                    rawData.forEach(row => {
                        if (row.date && typeof row.date === 'string') {
                            const parts = row.date.split('/');
                            if (parts.length === 3) {
                                let year = parseInt(parts[2]);
                                if (year < 100) year += year < 50 ? 2000 : 1900;
                                row.year = year;
                            }
                        }
                    });
                    
                    // Filter out rows with invalid dates
                    const validData = rawData.filter(row => row.year && !isNaN(row.year));
                    
                    // Get unique years in our target range (2012-2024)
                    const years = [...new Set(validData.map(row => row.year))]
                        .filter(year => year >= 2012 && year <= 2024)
                        .sort();
                    
                    // Aggregate data by year
                    const yearlyData = years.map(year => {
                        const yearRows = validData.filter(row => row.year === year);
                        
                        // Sum up different import volumes by country
                        const fromCanada = _.sumBy(yearRows, 'us_from_canada_crab_vol_lbs') || 0;
                        const fromRussia = _.sumBy(yearRows, 'us_from_russia_crab_vol_lbs') || 0;
                        const fromNorway = _.sumBy(yearRows, 'us_from_norway_crab_vol_lbs') || 0;
                        
                        // Calculate total imports and Canada's market share (excluding China)
                        const totalImports = fromCanada + fromRussia + fromNorway;
                        const canadaSharePercent = totalImports > 0 ? (fromCanada / totalImports * 100) : 0;
                        
                        return {
                            year,
                            Canada: fromCanada / 1000000, // Convert to millions of pounds
                            Russia: fromRussia / 1000000,
                            Norway: fromNorway / 1000000,
                            canadaSharePercent: canadaSharePercent
                        };
                    });
                    
                    // Create the chart
                    createChart(yearlyData, years);
                } catch (err) {
                    showError(`Error processing data: ${err.message}`);
                }
            }
            
            function createChart(data, years) {
                const ctx = document.getElementById('chart-container').getContext('2d');
                
                // Clean up existing chart if it exists
                if (chart) {
                    chart.destroy();
                }
                
                // Prepare datasets for Chart.js
                const canadaData = data.map(item => item.Canada);
                const russiaData = data.map(item => item.Russia);
                const norwayData = data.map(item => item.Norway);
                const shareData = data.map(item => item.canadaSharePercent);
                
                // Define colors
                const colors = {
                    canada: '#0066CC',
                    russia: '#CC0000',
                    norway: '#FF9900',
                    share: '#006400'
                };
                
                // Create chart with two y-axes (volume and percentage)
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [
                            {
                                label: 'Canada',
                                data: canadaData,
                                backgroundColor: colors.canada,
                                borderColor: colors.canada,
                                borderWidth: 1,
                                stack: 'Stack 0',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Russia',
                                data: russiaData,
                                backgroundColor: colors.russia,
                                borderColor: colors.russia,
                                borderWidth: 1,
                                stack: 'Stack 0',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Norway',
                                data: norwayData,
                                backgroundColor: colors.norway,
                                borderColor: colors.norway,
                                borderWidth: 1,
                                stack: 'Stack 0',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Canada Market Share (%)',
                                data: shareData,
                                type: 'line',
                                fill: false,
                                backgroundColor: colors.share,
                                borderColor: colors.share,
                                borderWidth: 3,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Million lbs'
                                },
                                stacked: true
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Canada Market Share (%)'
                                },
                                min: 0,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (label.includes('Market Share')) {
                                            label += context.parsed.y.toFixed(1) + '%';
                                        } else {
                                            label += context.parsed.y.toFixed(2) + ' million lbs';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Create custom legend
                createCustomLegend(colors);
            }
            
            function createCustomLegend(colors) {
                const legendContainer = document.getElementById('chart-legend');
                legendContainer.innerHTML = '';
                
                const legendItems = [
                    { label: 'Canada', color: colors.canada },
                    { label: 'Russia', color: colors.russia },
                    { label: 'Norway', color: colors.norway },
                    { label: 'Canada Market Share (%)', color: colors.share, isLine: true }
                ];
                
                legendItems.forEach(item => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    
                    const colorBox = document.createElement('div');
                    colorBox.className = 'legend-color';
                    colorBox.style.backgroundColor = item.color;
                    if (item.isLine) {
                        colorBox.style.height = '4px';
                        colorBox.style.marginTop = '8px';
                    }
                    
                    const label = document.createElement('span');
                    label.textContent = item.label;
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(label);
                    legendContainer.appendChild(legendItem);
                });
            }
            
            function showError(message) {
                chartContainer.innerHTML = `<div style="color: #cc0000; padding: 20px;">${message}</div>`;
                console.error(message);
            }
        });
    </script>
</body>
</html>